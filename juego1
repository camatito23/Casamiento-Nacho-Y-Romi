<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Corre por el Amor - Juego</title>

<!-- üî• FIREBASE v8 (COMPATIBLE CON firebase.firestore()) -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyBarMctnLiPEnW4hK20HcN7iuy1BuRWlEw",
    authDomain: "corre-por-el-amor.firebaseapp.com",
    projectId: "corre-por-el-amor",
    storageBucket: "corre-por-el-amor.firebasestorage.app",
    messagingSenderId: "930622249572",
    appId: "1:930622249572:web:25127b73f1ae59b052dd71",
    measurementId: "G-423YNBH8H1"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
</script>

<style>
    #gameCard{background:#F9F6F0;border:1px solid rgba(232,216,181,.9);border-radius:18px;
      box-shadow:0 12px 28px rgba(0,0,0,.08);overflow:hidden}
    #hud{display:flex;gap:10px;align-items:center;justify-content:space-between;padding:10px 14px;
      background:#A8B9A3;color:#243225}
    #hud .title{font-weight:700;letter-spacing:.02em}
    #hud .right{display:flex;gap:8px;align-items:center}
    #hud select,#hud button{appearance:none;border:1px solid rgba(32,32,32,.12);background:#fff;
      color:#2f2f2f;padding:8px 12px;border-radius:999px;font-weight:700;cursor:pointer}
    #hud button:hover{filter:brightness(1.02)}
    #gameArea{ position:relative;background:linear-gradient(#EDEBE6,#F9F6F0);height:40vw;
      max-height:360px;min-height:260px;}
    #gameCanvas{display:block;width:100%;height:100%;}

    #scoreboard{
      position:absolute; top:10px; right:10px; color:#4A6655; font-weight:700;
      text-align:right; font-size:16px; line-height:20px; z-index:50; user-select:none;
    }

    #overlay{position:absolute; inset:0; display:grid; place-items:center; text-align:center;
      color:#35423a; pointer-events:none}
    #overlay .card{background:rgba(255,255,255,.85); border:1px solid rgba(232,216,181,.9);
      backdrop-filter:blur(3px); padding:16px 18px; border-radius:14px}

    #smallNote{color:#6b6b6b;text-align:center;font-size:12px;margin:6px 0 0}
</style>
</head>
<body>


<section id="runner-wrap" style="max-width:900px;margin:32px auto;font-family:'Raleway',sans-serif;">

  <div id="gameCard">
    <div id="hud">
      <div class="title">üíç Corre por el Amor</div>
      <div class="right">
        <label style="font-weight:700;">Personaje:
          <select id="selChar">
            <option value="novio">Novio</option>
            <option value="novia">Novia</option>
          </select>
        </label>
        <button id="btnPause">‚è∏Ô∏è Pausa</button>
        <button id="btnMute">üîä Sonido</button>
        <button id="btnRestart">üîÅ Reiniciar</button>
      </div>
    </div>

    <div id="gameArea">
      <div id="scoreboard">
        <div id="scorePts">Puntos: 0</div>
        <div id="scoreBest">Mejor: 0</div>
        <div id="scoreHearts">Corazones: 0</div>
      </div>

      <canvas id="gameCanvas" width="900" height="260"></canvas>

      <div id="overlay">
        <div class="card" id="message">
          <h3>¬°Toc√° o presion√° ESPACIO ‚Üë para saltar!</h3>
          <div style="opacity:.8">Evit√° obst√°culos y agarr√° üíñ.</div>
        </div>
      </div>
    </div>

    <div id="smallNote">Controles: Espacio/‚Üë/Tap = Saltar ¬∑ P = Pausa ¬∑ M = Mute ¬∑ R = Reiniciar</div>
  </div>

  <!-- RANKING BOX -->
  <div id="rankingBox" 
     style="margin-top:25px; background:#ffffff; padding:18px; border-radius:14px; 
            border:1px solid #d8d8d8; max-width:600px; margin-left:auto; margin-right:auto;
            box-shadow:0 4px 12px rgba(0,0,0,0.08);">
      <h3 style="margin:0 0 12px 0;">üèÜ TOP 10 </h3>
      <div id="rankingList" style="font-size:16px; text-align:left;">Cargando...</div>
  </div>

</section>


<script>
/* ------------------ JUEGO ------------------ */

(()=>{

    const SAGE="#4A6655", GROUND="#CDBDA2";
    const canvas=document.getElementById('gameCanvas');
    const ctx=canvas.getContext('2d');
    const W=()=>canvas.width, H=()=>canvas.height;
    const area=document.getElementById('gameArea');

    const playerName = localStorage.getItem("playerName") || "Invitado";
    document.querySelector("#hud .title").innerHTML = `üíç ${playerName} ‚Äî Corre por el Amor`;

    const resize=()=>{
      const rect=area.getBoundingClientRect();
      canvas.width=Math.min(900, Math.max(340, Math.floor(rect.width)));
      canvas.height=260;
    };
    resize(); addEventListener('resize', resize);

    let muted=false;
    const beep=(f=660,d=0.08,t='sine',v=0.2)=>{
      if(muted) return;
      const AC=new (window.AudioContext||window.webkitAudioContext)();
      const o=AC.createOscillator(), g=AC.createGain();
      o.connect(g); g.connect(AC.destination);
      o.type=t; o.frequency.value=f; g.gain.value=v;
      o.start(); setTimeout(()=>{o.stop(); AC.close()}, d*1000);
    };

    /* SPRITES */
    const images={
      novio_walk:new Image(),
      novia_walk:new Image(),
      novio_jump:new Image(),
      novia_jump:new Image(),
    };
    images.novio_walk.src="novio_walk.png";
    images.novia_walk.src="novia_walk.png";
    images.novio_jump.src="novio_jump.png";
    images.novia_jump.src="novia_jump.png";

    const state={playing:false,paused:false,gameOver:false,score:0,best:0,speed:6,t:0};
    const selChar=document.getElementById('selChar');
    const savedChar = localStorage.getItem("chosenCharacter") || "novio";

    const player = { x:70, y:0, r:20, vy:0, onGround:false, kind:savedChar };

    const groundY=()=>H()-28;
    const gravity=0.7, jumpV=-12.5;

    let frame=0, frameTime=0;
    const FRAME_MS=90;
    const SCALE_WALK=0.15, SCALE_JUMP=0.08;
    let obstacles=[], hearts=[], particles=[];
    let shake=0, heartsCaught=0;
    let nextObs=800, nextHeart=1800;

    const btnPause=document.getElementById("btnPause");
    const btnMute=document.getElementById("btnMute");
    const btnRestart=document.getElementById("btnRestart");

    const togglePauseBtn=()=> btnPause.textContent=state.paused?"‚ñ∂Ô∏è Reanudar":"‚è∏Ô∏è Pausa";
    const toggleMuteBtn=()=> btnMute.textContent=muted?"üîá Silencio":"üîä Sonido";

    btnPause.onclick=()=>{ state.paused=!state.paused; togglePauseBtn(); };
    btnMute.onclick=()=>{ muted=!muted; toggleMuteBtn(); };
    btnRestart.onclick=()=> reset();

    const rand=(a,b)=>Math.random()*(b-a)+a;
    const now=()=>performance.now();

    /* RESET */
    function reset(){
      state.playing=false; state.paused=false; state.gameOver=false;
      state.score=0; heartsCaught=0; state.speed=6; state.t=0;
      frame=0; frameTime=0;
      obstacles=[]; hearts=[]; particles=[];

      player.kind = localStorage.getItem("chosenCharacter") || "novio";
      selChar.value = player.kind;

      player.y=groundY()-player.r;
      player.vy=0; player.onGround=true;

      nextObs=800; nextHeart=1800;

      document.getElementById("scorePts").textContent="Puntos: 0";
      document.getElementById("scoreBest").textContent="Mejor: "+state.best;
      document.getElementById("scoreHearts").textContent="Corazones: 0";

      togglePauseBtn(); toggleMuteBtn();
      document.getElementById("overlay").style.display='grid';

      draw(0);
      loadRanking();
    }

    function start(){
      if(state.gameOver) reset();
      state.playing=true;
      document.getElementById("overlay").style.display='none';
    }

    async function gameOver(){
      shake=8;
      state.gameOver=true; 
      state.playing=false;

      const finalScore = Math.floor(state.score);

      state.best = Math.max(state.best, finalScore);
      document.getElementById("scoreBest").textContent = "Mejor: " + state.best;

      await saveScoreToRanking(playerName, finalScore);

      document.getElementById("overlay").style.display='grid';
      document.getElementById("message").innerHTML =
          `<h3>¬°Fin del juego!</h3>
           <div>Puntuaci√≥n: <b>${finalScore}</b> ‚Äî Mejor: <b>${state.best}</b></div>
           <div style="margin-top:6px;opacity:.85">Presion√° R o Reiniciar</div>`;

      beep(180,0.18,'square',0.18);

      loadRanking();
    }

    addEventListener('keydown', e=>{
      const k=e.key.toLowerCase();
      if(k===' '||k==='arrowup') jump();
      else if(k==='p'){ state.paused=!state.paused; togglePauseBtn(); }
      else if(k==='m'){ muted=!muted; toggleMuteBtn(); }
      else if(k==='r'){ reset(); }
    });

    area.addEventListener('pointerdown', jump);
    selChar.addEventListener('change',()=> player.kind=selChar.value );

    function jump(){
      if(!state.playing){ start(); return; }
      if(state.paused||state.gameOver) return;
      if(player.onGround){
        player.vy=jumpV;
        player.onGround=false;
        beep(880,0.06,'sine',0.15);
      }
    }

    function spawnObstacle(){
      const types=[
        {emoji:'üí©', r:18, y:groundY()-18},
        {emoji:'üçæ', r:20, y:groundY()-16},
        {emoji:'üö©', r:16, y:groundY()-14}
      ];
      const t=types[Math.floor(Math.random()*types.length)];
      obstacles.push({x:W()+30, y:t.y, r:t.r, vx:state.speed, emoji:t.emoji});
      nextObs=now()+rand(900,1600);
    }

    function spawnHeart(){
      const y=groundY()-rand(50,120);
      hearts.push({x:W()+30, y, r:14, vx:state.speed*0.9, emoji:'üíñ'});
      nextHeart=now()+rand(2500,4200);
    }

    function update(dt){
      if(!state.playing || state.paused) return;

      state.t += dt;
      state.speed += dt * 0.0006;

      player.vy += gravity * dt * 0.06;
      player.y  += player.vy * dt * 0.06;

      if(player.y >= groundY() - player.r){
        player.y = groundY() - player.r;
        player.vy = 0;
        player.onGround = true;
      }

      if(player.onGround){
        frameTime+=dt;
        if(frameTime > FRAME_MS){
          frameTime = 0;
          frame = (frame+1) % 3;
        }
      }

      state.score += dt * 0.015;

      const t=now();
      if(t > nextObs) spawnObstacle();
      if(t > nextHeart) spawnHeart();

      obstacles = obstacles.filter(o=>{
        o.x -= state.speed * dt * 0.06;
        if(o.x < -40) return false;
        if(circleHit(player,o)){ gameOver(); return false; }
        return true;
      });

      hearts = hearts.filter(h=>{
        h.x -= state.speed * 0.96 * dt * 0.06;
        if(h.x < -40) return false;

        if(circleHit(player,h)){
          heartsCaught++;
          state.score += 20;
          document.getElementById("scoreHearts").textContent = `Corazones: ${heartsCaught}`;
          beep(980,0.06,'triangle',0.2);
          spawnHeartParticles(player.x,player.y-10);
          return false;
        }
        return true;
      });

      particles = particles.filter(p=>{
        p.x += p.vx;
        p.y += p.vy;
        p.vy += 0.05;
        p.life--;
        p.alpha = p.life / 38;
        return p.life > 0;
      });

      document.getElementById("scorePts").textContent=`Puntos: ${Math.floor(state.score)}`;
    }

    function circleHit(a,b){
      const dx=a.x-b.x, dy=a.y-b.y;
      return dx*dx+dy*dy <= (a.r+b.r)*(a.r+b.r);
    }

    function spawnHeartParticles(x,y){
      for(let i=0;i<10;i++){
        particles.push({
          x,y,
          vx:(Math.random()*2-1)*1.4,
          vy:(Math.random()*-1.5-0.5),
          life:28+Math.random()*10,
          alpha:1
        });
      }
    }

    function drawGround(){
      ctx.strokeStyle=GROUND; ctx.lineWidth=3;
      ctx.beginPath(); ctx.moveTo(0,groundY()+player.r);
      ctx.lineTo(W(),groundY()+player.r);
      ctx.stroke();

      ctx.fillStyle='rgba(205,189,162,.45)';
      for(let i=0;i<12;i++){
        const x=(i*80+(state.t*0.15))%(W()+80)-40;
        ctx.fillRect(x,groundY()+player.r-2,14,2);
      }
    }

    function drawPlayer(){
      const kind=player.kind;
      const imgWalk=images[kind+'_walk'];
      const imgJump=images[kind+'_jump'];

      if(!imgWalk.complete || !imgJump.complete){
        ctx.fillStyle=SAGE;
        ctx.beginPath(); ctx.arc(player.x,player.y,player.r,0,Math.PI*2);
        ctx.fill();
        return;
      }

      let img, sx, sy, sw, sh, scale;

      if(player.onGround){
        img=imgWalk;
        const fw=img.width/3;
        sx=fw*frame; sy=0; sw=fw; sh=img.height;
        scale=SCALE_WALK;
      } else {
        img=imgJump;
        sx=0; sy=0; sw=img.width; sh=img.height;
        scale=SCALE_JUMP;
      }

      const dw=sw*scale, dh=sh*scale;
      ctx.drawImage(img,sx,sy,sw,sh,player.x-dw/2,player.y-dh+player.r,dw,dh);
    }

    function drawEmoji(o){
      ctx.font="22px system-ui,Segoe UI Emoji";
      ctx.textAlign="center"; ctx.textBaseline="middle";
      ctx.fillText(o.emoji,o.x,o.y);
    }

    function draw(dt){
      let ox=0, oy=0;

      if(shake>0){
        ox=(Math.random()-0.5)*shake;
        oy=(Math.random()-0.5)*shake;
        shake*=0.9;
      }

      ctx.save();
      ctx.translate(ox,oy);
      ctx.clearRect(0,0,W(),H());

      const grad=ctx.createLinearGradient(0,0,0,H());
      grad.addColorStop(0,"#EDEBE6");
      grad.addColorStop(1,"#F9F6F0");
      ctx.fillStyle=grad;
      ctx.fillRect(0,0,W(),H());

      drawGround();
      drawPlayer();
      obstacles.forEach(drawEmoji);
      hearts.forEach(drawEmoji);

      particles.forEach(p=>{
        ctx.globalAlpha=p.alpha;
        ctx.fillStyle="#E25C6D";
        ctx.beginPath(); ctx.arc(p.x,p.y,4,0,Math.PI*2);
        ctx.fill();
        ctx.globalAlpha=1;
      });

      ctx.restore();
    }

    let prev=performance.now();
    function loop(t){
      const dt=Math.min(32, t-prev); prev=t;
      if(state.playing && !state.paused && !state.gameOver) update(dt);
      draw(dt);
      requestAnimationFrame(loop);
    }

    reset();
    requestAnimationFrame(loop);

    /* ---------------- FIREBASE RANKING ---------------- */

    async function saveScoreToRanking(name, score){
        const ref = db.collection("ranking").doc(name);
        const snap = await ref.get();

        if(snap.exists && score <= snap.data().score){
            return; 
        }

        await ref.set({
            name,
            score,
            timestamp: Date.now()
        });
    }

    async function loadRanking(){
        const box = document.getElementById("rankingList");
        box.innerHTML = "Cargando...";

        const snap = await db.collection("ranking")
                             .orderBy("score","desc")
                             .limit(10)
                             .get();

        if(snap.empty){
            box.innerHTML = "A√∫n no hay puntajes.";
            return;
        }

        let html = "";
        let pos = 1;

        snap.forEach(doc=>{
            const d = doc.data();
            const medal = pos===1?"ü•á":pos===2?"ü•à":pos===3?"ü•â":"üèÖ";

            html += `<div style="margin:6px 0;">
                        <b>${pos}. ${medal} ${d.name}</b> ‚Äî ${d.score} pts
                     </div>`;
            pos++;
        });

        box.innerHTML = html;
    }

})();
</script>

</body>
</html>
